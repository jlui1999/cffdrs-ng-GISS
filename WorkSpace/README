GISS branch of NG-CFFDRS code.
PLEASE ONLY USE THIS DIRECTORY (WorkSpace) TO RUN CODE

############################# Running FWI #############################

R code: Specify the directory of the code with environment variable R_Fire

Libraries required for R:
library(lubridate)
library(data.table)
library(lutz)

Packages required for python:
import pandas as pd
from datetime import datetime
from timezonefinder import TimezoneFinder
from pytz import timezone
import logging

To run tutorial code:
- python:   python ../GISS/giss_hourly_FWI.py ../data/wx_prf.csv PRF_py.csv
- R:        Rscript ../GISS/giss_hourly_FWI.py ../data/wx_prf.csv PRF_R.csv

FWI may be initialized with FFMC, DMC, and DC codes as arguments placed after the output file. By default, this is FFMC=85, DMC=6, DC=15. FWI can also be initialized from the data .csv file itself on the header line as #FFMC#DMC#DC place at the end of the header (as outputted by wx_convert_filter.sh).

Note that for the outputs, R's counting starts at 1 while python's starts at 0.

#########################  Preprocessing Data ##########################

wx_convert_filter.sh: Converts data to a format the FWI scripts can read.

  Arguments:
    - Input CSV file, in the format of

      YYYY,MM,DD,HH,TEMP_C,RH_PERC,VPD_HPA,WDSPD_KPH,PREC_MM,SNOWD_M,VIS_KM,FFMC,DMC,DC,BUI,ISI,FWI,OBSMINUTEDIFF_TEMP,OBSMINUTEDIFF_RH,OBSMINUTEDIFF_WDSPD,ISPRECREPORTED,OBSMINUTEDIFF_SNOW,OBSMINUTEDIFF_VIS
      1989,12,31,19,18.3,36.0860416675646,13.454787547469,37.08,0,0,20,NaN,NaN,NaN,NaN,NaN,NaN,0,0,0,1,0,0
      1989,12,31,20,16.5333333349787,42.0976523010093,11.7011221697317,30.9000000057556,0,0,20,NaN,NaN,NaN,NaN,NaN,NaN,300.000000055879,300.000000055879,300.000000055879,1,300.000000055879,300.000000055879
      1989,12,31,21,14.7666666650213,48.1092629512503,9.94745678709469,24.7199999942444,0,0,20,NaN,NaN,NaN,NaN,NaN,NaN,239.999999944121,239.999999944121,239.999999944121,1,239.999999944121,239.999999944121
      1989,12,31,22,13,54.120873584695,8.19379140935738,18.54,0,0,20,NaN,NaN,NaN,NaN,NaN,NaN,180,180,180,1,180,180
      1989,12,31,23,11.2333333349787,60.1324842181397,6.44012603162007,12.3600000057556,0,0,20,NaN,NaN,NaN,NaN,NaN,NaN,239.999999944121,239.999999944121,239.999999944121,1,239.999999944121,239.999999944121

      YYYY: year, local time
      MM: month, local time
      DD: day, local time
      HH: hour, local time
      TEMP_C: temperature in degrees celsius
      RH_PERC: relative humidity in percent
      VPD_HPA: vapor pressure deficit in hPa. This isn't an FWI input, but is interesting.
      WDSPD_KPH: windspeed in km per hour
      PREC_MM: hourly total precipitation in mm
      SNOWDEPTH_M: snow depth in meters
      VIS_KM: visibility in km. This isn't an FWI input, but is interesting.
      FFMC: Fine Fuel Moisture Code
      DMC: Duff Moisture Code
      DC: Drought Code
      BUI: Buildup Index
      ISI: Initial Spread Index
      FWI: Fire Weather Index
      DSR: Daily Severity Rating
      OBSMINUTEDIFF_TEMP: maximum of time difference in minutes between local 12:00pm and the closest real temperature observations before and after the local hour
      OBSMINUTEDIFF_RH: maximum of time difference in minutes between local 12:00pm and the closest real relative humidity observations before and after the local hour, meaning temperature and dew point
      OBSMINUTEDIFF_WDSPD: maximum of time difference in minutes between local 12:00pm and the closest real wind speed observations before and after the local hour
      ISPRECREPORTED: 1 if there was a precipitation report spanning that hour, 0 otherwise
      OBSMINUTEDIFF_SNOW: maximum of time difference in minutes between local 12:00pm and the closest real snow depth observations before and after the local hour
      OBSMINUTEDIFF_VIS: maximum of time difference in minutes between local 12:00pm and the closest real visibility observations before and after the local hour

    - Starting year of extraction
    - Ending year of extraction
    - ID/name of the weather station
    - Latitude of the weather station
    - Longitude of the weather station
    - Output file name

      Outputs will be given in the format of

      id,lat,long,timezone,yr,mon,day,hr,temp,rh,ws,prec
      718870-99999,50.702,-120.444,-8,2024,1,29,0,6.2,87.6321162616729,14.76,0.7
      718870-99999,50.702,-120.444,-8,2024,1,29,1,5,93.2480954480589,18.36,0.7
      718870-99999,50.702,-120.444,-8,2024,1,29,2,5,86.902676258922,14.76,0.7
      718870-99999,50.702,-120.444,-8,2024,1,29,3,4.8,91.2893265574923,20.52,0.7
      718870-99999,50.702,-120.444,-8,2024,1,29,4,5,86.902676258922,22.32,0.7

      id  Weather station identifier, a unique number for the station, text or number
      lat Latitude of weather station, decimal degrees (°) (double precision)
      long  Longitude of weather station, decimal degrees (°) (double precision)
      timezone UTC timezone of weather station, number
      yr  Year of weather station reading, number YYYY
      mon Month of weather station reading, number M or MM (must be consistent throughout the dataset)
      day Day of weather station reading, number DD or D (must be consistent throughout the dataset)
      hr  Hour of weather station reading, number in military time (0-23)
      temp  Temperature in degrees Celsius (°C), number
      rh  Relative humidity in percent (%), number (0-100)
      ws  Wind speed in kilometres per hour (km/hr), number
      prec  Precipitation (rain) measured in millimetres (mm), number

  The script will fetch from the data file the first and last lines above a threshold temperature (5 degrees C), and everything in between. This script also has an internal toggle 'init_fwi_values' to get the starting FWI codes. With 'init_fwi_values' set to true, the first line the script will fetch is the first line above the threshold temperature and has all FWI codes: FFMC, DMC, DC.

  NOTE: no output will be given if no line exists where all variables temp, rh, ws, prec are valid values (not NaN). Internally, this script will fill in NaNs with the previous value. This script will also check for discontinuities in hourly data (where data is missing for an hour or where a duplicate entry exists).

wx_batch_convert.sh: Batch converts data by calling wx_convert_filter.sh. Batch conversion will take places for files within a bounding longitude vaguely corresponding to Canada (-140 to -50). Batch conversion will ignore lines in the imput .csv list of files with a # in front.

  Arguments:
    - CSV list of files, in the format of

      WMOID,WMONAME,LAT,LON,HRLYMEANTIMEDIFFTOOBS_TEMP,HRLYMEANTIMEDIFFTOOBS_RH,HRLYMEANTIMEDIFFTOOBS_WDSPD,HRLYMEANPRECREPORTINGHRS,ISD_GHCN_PRECDIFFPERCENT,HRLYMEANTIMEDIFFTOOBS__VIS
      725920-24257,REDDING MUNICIPAL AIRPORT,40.52,-122.30,32,32,32,1,Inf,31
      723656-23049,SANTA FE MUNICIPAL AIRPORT,35.61,-106.10,84,84,80,1,Inf,80
      725025-94741,TETERBORO AIRPORT,40.86,-74.06,53,53,47,1,Inf,46
      702610-26411,FAIRBANKS INTERNATIONAL,64.80,-147.88,102,102,35,1,-8,36
      718890-99999,PENTICTON,49.46,-119.60,5,5,6,1,0,5

      NOTE: only the first four entries are read in, so the following file will also work

      WMOID,WMONAME,LAT,LON,ELEV,GHCNStnList
      166270-99999,DIMOKRITOS,40.856,25.956,7.3,NaN
      166990-99999,TANAGRA,38.34,23.565,147.8,NaN
      167150-99999,TATOI,38.109,23.784,239.3,NaN
      167180-99999,ELEFSIS,38.064,23.556,43.6,NaN
      167490-99999,DIAGORAS,36.405,28.086,5.8,NaN

    - Input directory of where the weather station data is stored
    - Starting year of extraction
    - Ending year of extraction
    - Output directory of converted files

############################  Plotting Data ###########################

plot_fwi.py: plots the data given from an output FWI run. Plots can be in the form of hourly FWI, maximum daily FWI, a combination of both, or a rolling average plot.

  Arguments:
    -i --input: Name of csv file of FWI output
    -o --output: Name of output file of FWI output (PDF or PNG)
    --name: Name of the station
    -m --mode: Changes the plot type (default, hourly, maxdaily, rolling)
    -p --period: Applicable for rolling plots only, specifies the number of days to take a rolling average of FWI
    --from: Date from where the plot starts, separated by spaces YYYY MM DD
    --to: Date to where plot ends, separated by spaces YYYY MM DD
    --all: Plot the entire date range of the file, ignored if either --from or --to are specified, not applicable for rolling plots

  If no dates are specified, then by default the plot will attempt to find the four-month fire season (average of four months in the dataset with the highest FWI) and plot those months in the last year in the dataset. If the last year in the dataset does not include at least one datapoint in the last month of the fire season (e.g. fire season is May-August, but the dataset ends in July), then the previous year will be plotted instead. If only --from is specified, then the plot will start from that date and go until the end of the file. If only --to is specified, then the plot will go from the beginning of the file to that date. For rolling plots, both dates must be specified or the plot will revert to finding the fire season. Rolling plots are allowed to 'go out of bounds' if the dates specified are outside the boundary of the data file.

  Example commands:
    python ../plot_fwi.py -i input.csv -o output.png --name "NAME"
      Default setting: plots the fire season of the latest year, plots both hourly FWI and maximum daily FWI (as a step plot)
    python ../plot_fwi.py -i input.csv -o output.png --name "NAME" --mode maxdaily
      Maximum daily FWI setting: calculates and plots the maximum daily FWI for the fire season of the latest year
    python ../plot_fwi.py -i input.csv -o output.png --name "NAME" --mode hourly
      Hourly FWI setting: plots the hourly FWI for the fire season of the latest year
    python ../plot_fwi.py -i input.csv -o output.png --name "NAME" --all
      Plot everything: plots the entire date range, plots both hourly FWI and maximum daily FWI (as a step plot)
    python ../plot_fwi.py -i input.csv -o output.png --name "NAME" --from 2020 3 19 --to 2020 5 31
      Plot selected: plots the selected date range, plots both hourly FWI and maximum daily FWI (as a step plot)
    python ../plot_fwi.py -i input.csv -o output.png --name "NAME" --from 2024 1 1
      Plot from: plots from January 1, 2024 to the end of the file, plots both hourly FWI and maximum daily FWI (as a step plot)
    python ../plot_fwi.py -i input.csv -o output.png --name "NAME" --to 1990 12 31
      Plot to: plots from beginning of the file to December 31, 1990, plots both hourly FWI and maximum daily FWI (as a step plot)
    python ../plot_fwi.py -i input.csv -o output.png --name "NAME" --mode rolling --period 21
      Rolling setting: plots the fire season of the latest year, plots the 21-day rolling average of FWI in the entire file with mean, interquartile range, 95%, and the average FWI
    python ../plot_fwi.py -i input.csv -o output.png --name "NAME" --mode rolling --period 21 --from 2020 3 19 --to 2020 5 31
      Rolling selected: plots the selected date range, plots the 21-day rolling average of FWI in the entire file with mean, interquartile range, 95%, and the average FWI
    
